import pandas as pd
from presidio_analyzer import AnalyzerEngine

# Initialize analyzer engine (use your custom model setup if needed)
analyzer = AnalyzerEngine()

# Load your actual dataframe
# df = pd.read_csv("your_dataset.csv")  # or however you're loading it

# Identify character/text columns, excluding 'cid'
char_cols = df.select_dtypes(include='object').columns
char_cols = [col for col in char_cols if col.lower() != "cid"]

# Optional: terms to ignore even if flagged
suppression_terms = set()

# Collect findings
findings = []

# Loop over each row and text column
for _, row in df.iterrows():
    cid = row["cid"]
    for col in char_cols:
        text = str(row[col])
        results = analyzer.analyze(
            text=text,
            language="en",
            entities=[
                "PERSON", "LOCATION", "AGE", "ID", "DATE_TIME", "EMAIL",
                "PHONE_NUMBER", "OTHER", "ORGANIZATION"
            ]
        )
        for res in results:
            matched_text = text[res.start:res.end].lower()
            if matched_text in suppression_terms:
                continue
            findings.append({
                "CID": cid,
                "Column": col,
                "Text": text,
                "Entity": res.entity_type,
                "Matched Text": text[res.start:res.end],
                "Score": res.score
            })

# Output to DataFrame
findings_df = pd.DataFrame(findings)
print(findings_df.head())  # or save to file
# findings_df.to_csv("phi_findings.csv", index=False)

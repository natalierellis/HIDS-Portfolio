
import re

def is_false_positive_person(row):
    if row['Entity'] != "PERSON":
        return False  # Keep non-PERSON entities

    text = row['Text']
    text_lower = text.lower()
    start = row['Start']
    end = row['End']
    span = text_lower[start:end].strip()

    # Case 1: Exclude fragments related to "last tdan fu"
    if any(term in span for term in ["last", "tdan", "td", "an", "fu"]):
        return True

    # Case 2: Exclude if entity is within 3 words after "Dr." (case-insensitive)
    # Tokenize the sentence with positions
    tokens = list(re.finditer(r"\b\w+\b", text_lower))
    for i, token in enumerate(tokens):
        if token.group().rstrip(".") == "dr":
            # Look at next 3 tokens
            dr_end = token.end()
            for j in range(i + 1, min(i + 4, len(tokens))):  # up to 3 words after "Dr"
                tok_start = tokens[j].start()
                tok_end = tokens[j].end()
                # If entity span overlaps with either of these tokens, mark as false positive
                if not (end <= tok_start or start >= tok_end):  # overlapping
                    return True

    return False

filtered_df = filtered_df[~filtered_df.apply(is_false_positive_person, axis = 1)]

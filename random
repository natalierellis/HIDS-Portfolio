#Step 1: Log-transform TTC
library(dplyr)
library(tidyr)
library(gt)

library(ggplot2)

# What is the distribution again? 
#Right-skewed distribution 
NCDB_model %>%
  ggplot(aes(x = TTC_weeks)) +
  geom_histogram(fill = "steelblue", color = "white") +
  labs(
    x = "Weeks from Surgery to Chemotherapy",
    y = "Patient Count"
  ) + 
  theme_minimal(base_size = 12) +
  theme(
    text = element_text(family = "Calibri"),
    axis.title = element_text(size = 14),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    plot.background = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    axis.text = element_text(size = 12, color = "black")
  )

#Apply log transformation
NCDB_model$log_TTC <- log(NCDB_model$TTC_weeks + 1)

#Plot
NCDB_model %>%
  ggplot(aes(x = log_TTC)) +
  geom_histogram(fill = "steelblue", color = "white") +
  labs(
    x = "Weeks from Surgery to Chemotherapy",
    y = "Patient Count"
  ) + 
  theme_minimal(base_size = 12) +
  theme(
    text = element_text(family = "Calibri"),
    axis.title = element_text(size = 14),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    plot.background = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    axis.text = element_text(size = 12, color = "black")
  )

#Step 2: Fit univariate cox model with splines
library(rms)
dd <- datadist(NCDB_model)
options(datadist = 'dd')

cox_splines <- cph(Surv(DX_LASTCONTACT_DEATH_YEARS, EVENT) ~ rcs(log_TTC, 4), data = NCDB_model)
summary(cox_splines)

#Step 3: Create figure

library(ggplot2)

pred <- Predict(cox_splines, "log_TTC", fun = exp)
pred_df <- as.data.frame(pred)

# Back-transform x-axis to weeks
pred_df$TTC_WEEKS <- (exp(pred_df$log_TTC) - 1)
pred_df <- pred_df %>%
  filter(TTC_WEEKS <= 18)
# Create clean plot
ggplot(pred_df, aes(x = TTC_WEEKS, y = yhat)) +
  geom_line(color = "black", size = 1.2) +  # Main HR curve
  geom_line(aes(y = lower), linetype = "dashed", color = "black", size = 0.6) +  # Lower CI
  geom_line(aes(y = upper), linetype = "dashed", color = "black", size = 0.6) +  # Upper CI
  scale_x_continuous(breaks = c(0, 4, 8, 12, 16)) +
  scale_y_continuous(breaks = function(x) pretty(c(0,x))) +
  labs(x = "Time to Chemotherapy (Weeks)",
       y = "Hazard Ratio") +
  theme_classic(base_size = 12) +  # Clean theme like survminer
  theme(
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12, color = "black"),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    plot.title = element_blank(),
    panel.grid = element_blank()
  )

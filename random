import pandas as pd
from presidio_analyzer import AnalyzerEngine

# Load your REDCap CSV export
df = pd.read_csv("redcap_report.csv")

# Initialize analyzer
analyzer = AnalyzerEngine()

# Identify text columns, excluding 'cid'
char_cols = df.select_dtypes(include='object').columns
char_cols = [col for col in char_cols if col.lower() != "cid"]

# Store findings in a list
findings = []

# Loop over rows and columns to scan text
for _, row in df.iterrows():
    cid = row["cid"]  # Use cid as unique identifier

    for col in char_cols:
        cell = str(row[col])
        results = analyzer.analyze(text=cell, language='en')

        for res in results:
            findings.append({
                "CID": cid,
                "Column": col,
                "Text": cell,
                "Entity": res.entity_type,
                "Start": res.start,
                "End": res.end,
                "Matched Text": cell[res.start:res.end],
                "Score": res.score
            })

# Convert findings to DataFrame
findings_df = pd.DataFrame(findings)

# Save or view
findings_df.to_csv("phi_flags_report.csv", index=False)
findings_df.head()

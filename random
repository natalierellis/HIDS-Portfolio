library(dplyr)
library(rms)
library(ggplot2)

# Clean and group margins variable
NCDB_model <- NCDB_model %>%
  mutate(surg_margin_group = case_when(
    RX_SUMM_SURGICAL_MARGINS %in% c("No residual tumor", "R0") ~ "No residual tumor",
    RX_SUMM_SURGICAL_MARGINS %in% c("Residual disease", "R1", "R2") ~ "Residual disease",
    TRUE ~ NA_character_
  )) %>%
  filter(!is.na(surg_margin_group))

# Create container for prediction results
plot_data <- bind_rows(
  lapply(unique(NCDB_model$surg_margin_group), function(g) {
    subset_data <- NCDB_model %>% filter(surg_margin_group == g)

    # Assign a datadist object to a global variable (required by rms)
    dd_temp <<- datadist(subset_data)
    options(datadist = "dd_temp")

    # Fit spline-based Cox model
    model <- cph(Surv(DX_LASTCONTACT_DEATH_YEARS, EVENT) ~ rcs(log_TTC, 4),
                 data = subset_data, x = TRUE, y = TRUE)

    # Predict HR vs log_TTC
    pred <- Predict(model, "log_TTC", fun = exp)
    pred_df <- as.data.frame(pred)
    pred_df$TTC_WEEKS <- exp(pred_df$log_TTC) - 1
    pred_df$surg_margin_group <- g

    return(pred_df)
  })
)

# Optional: limit to reasonable range
plot_data <- plot_data %>% filter(TTC_WEEKS <= 18)

# Final plot
ggplot(plot_data, aes(x = TTC_WEEKS, y = yhat, color = surg_margin_group, fill = surg_margin_group)) +
  geom_line(size = 1.2) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2, linetype = "blank", color = NA) +
  scale_x_continuous(breaks = c(0, 4, 8, 12, 16)) +
  scale_y_continuous(breaks = function(x) pretty(c(0, x))) +
  labs(
    x = "Time to Chemotherapy (Weeks)",
    y = "Hazard Ratio",
    color = "Surgical Margins",
    fill = "Surgical Margins"
  ) +
  theme_classic(base_size = 12) +
  theme(
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12, color = "black"),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    plot.title = element_blank(),
    panel.grid = element_blank()
  )

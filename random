import pandas as pd
from presidio_analyzer import AnalyzerEngine

# Load your REDCap CSV export
df = pd.read_csv("redcap_report.csv")

# Initialize analyzer
analyzer = AnalyzerEngine()

# Identify character columns (text fields)
char_cols = df.select_dtypes(include='object').columns

# Store findings in a list
findings = []

# Loop over rows and columns to scan text
for idx, row in df.iterrows():
    for col in char_cols:
        cell = str(row[col])
        results = analyzer.analyze(text=cell, language='en')

        for res in results:
            findings.append({
                "Row": idx,
                "Column": col,
                "Text": cell,
                "Entity": res.entity_type,         # e.g., PERSON, DATE, PHONE_NUMBER
                "Start": res.start,
                "End": res.end,
                "Matched Text": cell[res.start:res.end],
                "Score": res.score                 # Confidence score from 0 to 1
            })

# Convert findings to DataFrame
findings_df = pd.DataFrame(findings)

# Save or view
findings_df.to_csv("phi_flags_report.csv", index=False)
findings_df.head()

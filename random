#Encode TTC Groups
library(dplyr)
NCDB <- NCDB %>%
  mutate(TTC_GROUP = case_when(
    TTC_weeks <= 3 ~ "3 Weeks or Less",
    TTC_weeks <= 5 ~ "3 to 5 Weeks",
    TTC_weeks <= 7 ~ "5 to 7 Weeks",
    TTC_weeks <= 12 ~ "7 to 12 Weeks",
    TTC_weeks > 12 ~ "More than 12 Weeks",
    
    TRUE ~ NA_character_  # handles missing or unexpected values
  ))


#Step 7: Plot KM Stratified by TTC & Run Log Rank
install.packages("viridis")
library(viridis)
palette = viridis(4)
NCDB$TTC_GROUP <- factor(NCDB$TTC_GROUP, levels = c("3 to 5 Weeks",22 - 42 Days", "43 - 70 Days","71+ Days"?"))
surv_object <- Surv(time = NCDB$DX_LASTCONTACT_DEATH_YEARS, event = NCDB$EVENT)
KM <- survfit(surv_object ~ NCDB$TTC_GROUP)
ggsurvplot(KM, data = NCDB, 
           xlab = "Months from Diagnosis",
           ylab = "Overall Survival Probability",
           legend.title = "TTC Group",
           palette = palette,
           conf.int = TRUE,
           censor = TRUE)
